name: Cache and Setup Compiler Toolchain
description: Caches and sets up compiler toolchains to speed up subsequent installations in GitHub Actions workflows.
author: David C. Manuelda
email: StormByte@gmail.com
branding:
  icon: 'settings'
  color: 'green'

inputs:
  toolchain:
    description: 'The name of the compiler toolchain to install and cache (gcc, clang or clang-libc++).'
    required: true
    default: ''
  docs:
    description: 'Whether to install documentation generation tools (Doxygen, Sphinx, etc.) along with the toolchain.'
    required: false
    default: 'false'
  version:
    description: 'Optional toolchain major version (single value for gcc/clang). Leave empty to use sensible defaults.'
    required: false
    default: ''
  ccache-key:
    description: 'Optional cache key for ccache. If empty, ccache restore/save is disabled.'
    required: false
    default: ''

outputs:
  c_compiler:
    description: 'Path to C compiler selected.'
    value: ${{ steps.set-outputs.outputs.c_compiler }}
  cxx_compiler:
    description: 'Path to C++ compiler selected.'
    value: ${{ steps.set-outputs.outputs.cxx_compiler }}

runs:
  using: "composite"
  steps:

    ###########################################################################
    # 0. EARLY CREATION OF CCACHE DIRECTORY (fixes post-job cache issues)
    ###########################################################################
    - name: Ensure ccache directory exists early (Linux)
      if: ${{ runner.os == 'Linux' && inputs.ccache-key != '' }}
      shell: bash
      run: |
        mkdir -p "$HOME/.ccache"
        echo "CCACHE_DIR=$HOME/.ccache" >> "$GITHUB_ENV"

    ###########################################################################
    # 1. VERSION RESOLUTION
    ###########################################################################
    - name: Set and validate toolchain version input
      shell: bash
      run: |
        set -euo pipefail
        if [[ "${{ inputs.toolchain }}" == "msvc" && -n "${{ inputs.version }}" ]]; then
          echo "Error: 'version' must not be set when toolchain is 'msvc'" >&2
          exit 1
        fi

        VER="${{ inputs.version }}"

        if [[ "${{ inputs.toolchain }}" == "gcc" ]]; then
          GCC_VER="${VER:-14}"
          CLANG_VER=20
        elif [[ "${{ inputs.toolchain }}" == "clang" || "${{ inputs.toolchain }}" == "clang-libc++" ]]; then
          CLANG_VER="${VER:-20}"
          GCC_VER=14
        else
          GCC_VER=14
          CLANG_VER=20
        fi

        echo "GCC_VERSION=$GCC_VER" >> "$GITHUB_ENV"
        echo "CLANG_VERSION=$CLANG_VER" >> "$GITHUB_ENV"

    - name: Check toolchain input (Linux only)
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        if [[ "${{ inputs.toolchain }}" != "gcc" && "${{ inputs.toolchain }}" != "clang" && "${{ inputs.toolchain }}" != "clang-libc++" ]]; then
          echo "Error: Unsupported toolchain '${{ inputs.toolchain }}'. Supported: gcc, clang, clang-libc++."
          exit 1
        fi

    - name: Check toolchain input (Windows only)
      if: ${{ runner.os == 'Windows' }}
      shell: pwsh
      run: |
        if ("${{ inputs.toolchain }}" -ne "msvc") {
          Write-Error "Unsupported toolchain '${{ inputs.toolchain }}'. Only msvc is supported."
          exit 1
        }

    ###########################################################################
    # 2. COMMON TOOLS
    ###########################################################################
    - name: Install Ninja
      if: ${{ runner.os == 'Linux' }}
      uses: stormbytepp/githubactions/.github/actions/install-cached@master
      with:
        packages: "ninja-build"
        cache-key: "apt-ninja-v1"

    - name: Install Ninja
      if: ${{ runner.os == 'Windows' }}
      shell: pwsh
      run: |
        choco install ninja -y

    - name: Install Python and pip
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Install Meson 1.4.0
      shell: pwsh
      run: |
        pip install meson==1.4.0
        meson --version

    ###########################################################################
    # 3. TOOLCHAIN INSTALLATION (LINUX)
    ###########################################################################
    - name: Install toolchain (Linux gcc)
      if: ${{ runner.os == 'Linux' && inputs.toolchain == 'gcc' }}
      uses: stormbytepp/githubactions/.github/actions/install-cached@master
      with:
        packages: "build-essential gcc-${{ env.GCC_VERSION }} g++-${{ env.GCC_VERSION }} cmake"
        cache-key: "apt-toolchain-gcc-${{ env.GCC_VERSION }}"

    - name: Register GCC alternatives
      if: ${{ runner.os == 'Linux' && inputs.toolchain == 'gcc' }}
      shell: bash
      run: |
        sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-${{ env.GCC_VERSION }} 140
        sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-${{ env.GCC_VERSION }} 140
        sudo update-alternatives --set gcc /usr/bin/gcc-${{ env.GCC_VERSION }}
        sudo update-alternatives --set g++ /usr/bin/g++-${{ env.GCC_VERSION }}

    - name: Install toolchain (Linux clang)
      if: ${{ runner.os == 'Linux' && inputs.toolchain == 'clang' }}
      uses: stormbytepp/githubactions/.github/actions/install-cached@master
      with:
        packages: "build-essential clang-${{ env.CLANG_VERSION }} clang++-${{ env.CLANG_VERSION }} cmake"
        cache-key: "apt-toolchain-clang-${{ env.CLANG_VERSION }}"

    - name: Install toolchain (Linux clang-libc++)
      if: ${{ runner.os == 'Linux' && inputs.toolchain == 'clang-libc++' }}
      uses: stormbytepp/githubactions/.github/actions/install-cached@master
      with:
        packages: "build-essential clang-${{ env.CLANG_VERSION }} clang++-${{ env.CLANG_VERSION }} libc++-${{ env.CLANG_VERSION }}-dev libc++abi-${{ env.CLANG_VERSION }}-dev clang-format-${{ env.CLANG_VERSION }} clang-tidy-${{ env.CLANG_VERSION }} cmake"
        cache-key: "apt-toolchain-clang-libc++-${{ env.CLANG_VERSION }}"

    - name: Register Clang alternatives
      if: ${{ runner.os == 'Linux' && (inputs.toolchain == 'clang' || inputs.toolchain == 'clang-libc++') }}
      shell: bash
      run: |
        sudo update-alternatives --remove-all clang || true
        sudo update-alternatives --remove-all clang++ || true
        sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-${{ env.CLANG_VERSION }} 200 --slave /usr/bin/clang++ clang++ /usr/bin/clang++-${{ env.CLANG_VERSION }}

    ###########################################################################
    # 3. TOOLCHAIN INSTALLATION (WINDOWS)
    ###########################################################################
    - name: Setup MSVC environment
      if: ${{ runner.os == 'Windows' }}
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x64

    ###########################################################################
    # 4. CCACHE (LINUX)
    ###########################################################################
    - name: Install ccache (Linux)
      if: ${{ runner.os == 'Linux' && inputs.ccache-key != '' }}
      uses: stormbytepp/githubactions/.github/actions/install-cached@master
      with:
        packages: "ccache"
        cache-key: "apt-ccache-linux-v1"

    - name: Ensure ccache symlinks are first in PATH
      if: ${{ runner.os == 'Linux' && inputs.ccache-key != '' }}
      shell: bash
      run: |
        if [ -d /usr/lib/ccache ]; then
          echo "PATH=/usr/lib/ccache:$PATH" >> "$GITHUB_ENV"
        elif [ -d /usr/lib64/ccache ]; then
          echo "PATH=/usr/lib64/ccache:$PATH" >> "$GITHUB_ENV"
        fi

    - name: Configure ccache
      if: ${{ runner.os == 'Linux' && inputs.ccache-key != '' }}
      shell: bash
      run: |
        echo "CCACHE_MAXSIZE=2G" >> "$GITHUB_ENV"
        ccache -M 2G || true

    - name: Determine toolchain cache version
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        if [[ "${{ inputs.toolchain }}" == "gcc" ]]; then
          echo "TOOLCHAIN_VERSION=${GCC_VERSION}" >> "$GITHUB_ENV"
        elif [[ "${{ inputs.toolchain }}" == "clang" || "${{ inputs.toolchain }}" == "clang-libc++" ]]; then
          echo "TOOLCHAIN_VERSION=${CLANG_VERSION}" >> "$GITHUB_ENV"
        else
          echo "TOOLCHAIN_VERSION=default" >> "$GITHUB_ENV"
        fi

    - name: Compute ccache full key
      if: ${{ runner.os == 'Linux' && inputs.ccache-key != '' }}
      shell: bash
      run: |
        USER_SUFFIX="${{ inputs.ccache-key }}"
        SANITIZED=$(echo "$USER_SUFFIX" | tr ' /' '-' | sed 's/[^A-Za-z0-9._+-]/-/g')
        echo "CCACHE_FULL_KEY=ccache-${{ inputs.toolchain }}-${TOOLCHAIN_VERSION}-${SANITIZED}" >> "$GITHUB_ENV"

    - name: Restore ccache
      if: ${{ runner.os == 'Linux' && inputs.ccache-key != '' }}
      id: restore-ccache
      uses: actions/cache@v4
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ${{ env.CCACHE_FULL_KEY }}

    ###########################################################################
    # 9. OUTPUTS
    ###########################################################################
    - name: Set outputs and environment variables
      id: set-outputs
      shell: pwsh
      run: |
        $toolchain = "${{ inputs.toolchain }}"

        if ($toolchain -eq "gcc") {
          $c  = "gcc"
          $cxx = "g++"
        }
        elseif ($toolchain -eq "clang" -or $toolchain -eq "clang-libc++") {
          $c  = "clang"
          $cxx = "clang++"
        }
        else {
          $c  = "cl"
          $cxx = "cl"
        }

        "c_compiler=$c"     >> $env:GITHUB_OUTPUT
        "cxx_compiler=$cxx" >> $env:GITHUB_OUTPUT
        "CC=$c"             >> $env:GITHUB_ENV
        "CXX=$cxx"          >> $env:GITHUB_ENV

    ###########################################################################
    # 10. SAVE CCACHE / CLCACHE
    ###########################################################################
    - name: Randomized delay before saving ccache
      if: ${{ success() && env.CCACHE_FULL_KEY != '' && runner.os == 'Linux' }}
      shell: bash
      run: |
        sleep $(( (RANDOM % 15) + 1 ))

    - name: Delete existing ccache entry (Linux)
      if: ${{ success() && env.CCACHE_FULL_KEY != '' && runner.os == 'Linux' }}
      shell: bash
      run: |
        set -euo pipefail

        if [ -z "${GITHUB_TOKEN:-}" ]; then
          echo "‚ùå ERROR: GITHUB_TOKEN no est√° definido"
          exit 1
        fi

        ENC_KEY=$(python3 -c "import urllib.parse, os; print(urllib.parse.quote(os.environ['CCACHE_FULL_KEY'], safe=''))")
        REPO="${GITHUB_REPOSITORY}"
        TOKEN="${GITHUB_TOKEN}"

        echo "üîç Consultando API de GitHub para borrar cache‚Ä¶"
        HTTP_CODE=$(curl -s -o resp.json -w "%{http_code}" \
          -H "Authorization: token $TOKEN" \
          "https://api.github.com/repos/${REPO}/actions/caches?key=${ENC_KEY}")

        echo "üîç HTTP code: $HTTP_CODE"
        echo "üîç Respuesta cruda del servidor:"
        cat resp.json || true
        echo "----------------------------------------"

        if [ "$HTTP_CODE" -ne 200 ]; then
          echo "‚ùå ERROR: La API devolvi√≥ un c√≥digo inesperado ($HTTP_CODE)"
          exit 1
        fi

        if ! head -c 1 resp.json | grep -q '{'; then
          echo "‚ùå ERROR: La respuesta NO es JSON v√°lido"
          exit 1
        fi

        cache_id=$(python3 -c "import json; data=json.load(open('resp.json')); caches=data.get('actions_caches', []); print(caches[0].get('id') if caches else '')")

        if [ -z "$cache_id" ]; then
          echo '‚ÑπÔ∏è No se encontr√≥ ninguna entrada de cache para borrar'
          exit 0
        fi

        echo "üóëÔ∏è Borrando cache id $cache_id"
        DELETE_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
          -X DELETE -H "Authorization: token $TOKEN" \
          "https://api.github.com/repos/${REPO}/actions/caches/${cache_id}")

        if [ "$DELETE_CODE" -ne 204 ]; then
          echo "‚ùå ERROR: Fallo al borrar la cache (HTTP $DELETE_CODE)"
          exit 1
        fi

        echo "‚úÖ Cache borrada correctamente"

    - name: Save updated ccache
      if: ${{ success() && env.CCACHE_FULL_KEY != '' }}
      uses: actions/cache@v4
      with:
        path: ${{ env.CCACHE_DIR }}
        key: ${{ env.CCACHE_FULL_KEY }}
